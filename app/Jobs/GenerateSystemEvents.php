<?php

namespace App\Jobs;

use App\Models\PublicSector;
use App\Models\SystemEvent;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldBeUnique;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Arr;

class GenerateSystemEvents implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    public function handle()
    {

        $messages = [
            "Accepted publickey for ubuntu from 41.139.171.26 port 62989 ssh2: RSA SHA256:F1AXi1KnD/os9QE4+MedGv0pYvpiltQm+QUzTlBr/gY",
            "Accepted publickey for ubuntu from 41.139.171.26 port 62989 ssh2: RSA SHA256:F1AXi1KnD/os9QE4+MedGv0pYvpiltQm+QUzTlBr/gY",
            "pam_unix(sshd:session): session opened for user ubuntu by (uid=0)",
            "Created slice User Slice of UID 1000.",
            "Starting User Runtime Directory /run/user/1000...",
            "New session 1 of user ubuntu.",
            "Finished User Runtime Directory /run/user/1000.",
            "Starting User Manager for UID 1000...",
            "pam_unix(systemd-user:session): session opened for user ubuntu by (uid=0)",
            "Reached target Paths.",
            "Reached target Timers.",
            "Starting D-Bus User Message Bus Socket.",
            "Listening on GnuPG network certificate management daemon.",
            "Listening on GnuPG cryptographic agent and passphrase cache (access for web browsers).",
            "Listening on GnuPG cryptographic agent and passphrase cache (restricted).",
            "pam_unix(systemd-user:session): session opened for user ubuntu by (uid=0)",
            "ubuntu : TTY=pts/0 ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/bin/su",
            "pam_unix(sudo:session): session opened for user root by ubuntu(uid=0)",
            "Disconnected from invalid user support 148.70.123.42 port 41138 [preauth]",
            "Invalid user apache from 124.156.105.251 port 37586",
            "Received disconnect from 124.156.105.251 port 37586:11: Bye Bye [preauth]",
            "Disconnected from invalid user apache 124.156.105.251 port 37586 [preauth]",
            "Received disconnect from 206.189.228.21 port 48022:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 206.189.228.21 port 48022 [preauth]",
            "Received disconnect from 193.112.101.68 port 43616:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 193.112.101.68 port 43616 [preauth]",
            "Received disconnect from 82.156.67.68 port 45923:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 82.156.67.68 port 45923 [preauth]",
            "Received disconnect from 192.64.82.114 port 33766:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 192.64.82.114 port 33766 [preauth]",
            "action 'action-8-ommysql' resumed (module 'ommysql') [v8.2001.0 try https://www.rsyslog.com/e/2359 ]",
            "Accepted publickey for ubuntu from 41.139.171.26 port 58535 ssh2: RSA SHA256:F1AXi1KnD/os9QE4+MedGv0pYvpiltQm+QUzTlBr/gY",
            "Accepted publickey for ubuntu from 41.139.171.26 port 58535 ssh2: RSA SHA256:F1AXi1KnD/os9QE4+MedGv0pYvpiltQm+QUzTlBr/gY",
            "pam_unix(sshd:session): session opened for user ubuntu by (uid=0)",
            "(to root) ubuntu on pts/1",
            "pam_unix(su:session): session opened for user root by ubuntu(uid=0)",
            "pam_unix(sudo:session): session opened for user root by ubuntu(uid=0)",
            "(to root) ubuntu on pts/1",
            "pam_unix(su:session): session opened for user root by ubuntu(uid=0)",
            "ip-172-31-45-229,root,localhost,38,0,CONNECT,,,0",
            "ip-172-31-45-229,root,localhost,38,72,QUERY,,'select @@version_comment limit 1',0",
            "ip-172-31-45-229,root,localhost,38,73,QUERY,,'show varialbes like \\'%audit%\\'',1064",
            "ip-172-31-45-229,root,localhost,38,74,QUERY,,'show variables like \\'%audit%\\'',0",
            "ip-172-31-45-229,root,localhost,38,75,QUERY,,'show status like \\'%audit%\\'',0",
            "ip-172-31-45-229,root,localhost,38,0,DISCONNECT,,,0",
            "ip-172-31-45-229,root,localhost,39,0,CONNECT,,,0",
            "ip-172-31-45-229,root,localhost,39,77,QUERY,,'select @@version_comment limit 1',0",
            "ip-172-31-45-229,root,localhost,39,78,QUERY,,'show databases',0",
            "ip-172-31-45-229,root,localhost,39,79,QUERY,,'SELECT DATABASE()',0",
            "ip-172-31-45-229,root,localhost,39,81,QUERY,Syslog,'show databases',0",
            "ip-172-31-45-229,root,localhost,39,82,QUERY,Syslog,'show tables',0",
            "ip-172-31-45-229,root,localhost,39,85,QUERY,Syslog,'show tables',0",
            "ip-172-31-45-229,root,localhost,39,86,QUERY,Syslog,'select * from SystemEvents',0",
            "ip-172-31-45-229,root,localhost,39,0,DISCONNECT,Syslog,,0",
            "pam_unix(cron:session): session closed for user root",
            "action 'action-9-ommysql' resumed (module 'ommysql') [v8.2001.0 try https://www.rsyslog.com/e/2359 ]",
            "action 'action-8-ommysql' resumed (module 'ommysql') [v8.2001.0 try https://www.rsyslog.com/e/2359 ]",
            "Received disconnect from 114.246.34.145 port 42200:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 114.246.34.145 port 42200 [preauth]",
            "Received disconnect from 81.70.210.74 port 43450:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 81.70.210.74 port 43450 [preauth]",
            "error: kex_exchange_identification: Connection closed by remote host",
            "Unable to negotiate with 205.185.125.109 port 48660: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 205.185.125.109 port 55440: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "pam_unix(sshd:session): session closed for user ubuntu",
            "pam_unix(su:session): session closed for user root",
            "Session 3 logged out. Waiting for processes to exit.",
            "pam_unix(sudo:session): session closed for user root",
            "Removed session 3.",
            "Invalid user postgres from 209.141.48.127 port 44186",
            "Invalid user test from 209.141.48.127 port 44182",
            "Invalid user ec2-user from 209.141.48.127 port 44176",
            "Invalid user vagrant from 209.141.48.127 port 44184",
            "Connection closed by invalid user postgres 209.141.48.127 port 44186 [preauth]",
            "Connection closed by authenticating user ubuntu 209.141.48.127 port 44180 [preauth]",
            "Connection closed by invalid user vagrant 209.141.48.127 port 44184 [preauth]",
            "Connection closed by invalid user test 209.141.48.127 port 44182 [preauth]",
            "Connection closed by authenticating user root 209.141.48.127 port 44178 [preauth]",
            "Connection closed by invalid user ec2-user 209.141.48.127 port 44176 [preauth]",
            "Connection reset by 222.186.30.112 port 11360 [preauth]",
            "pam_unix(cron:session): session opened for user root by (uid=0)",
            "pam_unix(cron:session): session closed for user root",
            "Received disconnect from 222.190.145.130 port 53015:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 222.190.145.130 port 53015 [preauth]",
            "error: kex_exchange_identification: Connection closed by remote host",
            "Received disconnect from 81.69.99.84 port 46018:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 81.69.99.84 port 46018 [preauth]",
            "error: kex_exchange_identification: Connection closed by remote host",
            "Unable to negotiate with 209.141.48.24 port 60808: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Received disconnect from 101.32.74.75 port 57494:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 101.32.74.75 port 57494 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 38510: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 44442: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 50374: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 56300: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 33996: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 39930: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 45864: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Received disconnect from 212.119.190.162 port 51543:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 212.119.190.162 port 51543 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 51810: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 57730: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 35430: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 41360: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 47294: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Received disconnect from 115.42.44.26 port 36110:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 115.42.44.26 port 36110 [preauth]",
            "pam_unix(cron:session): session opened for user root by (uid=0)",
            "pam_unix(cron:session): session closed for user root",
            "Unable to negotiate with 209.141.48.24 port 53224: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 59162: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 36862: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 42786: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 48724: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 54658: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Received disconnect from 119.28.78.126 port 43878:11: Bye Bye [preauth]",
            "Disconnected from authenticating user root 119.28.78.126 port 43878 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 60590: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 38290: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 44218: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 50154: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]",
            "Unable to negotiate with 209.141.48.24 port 56084: no matching key exchange method found. Their offer: diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1 [preauth]"
        ];

        $tags = [
            "sshd[892]:",
            "sshd[892]:",
            "sshd[892]:",
            "systemd[1]:",
            "systemd[1]:",
            "systemd-logind[437]:",
            "systemd[1]:",
            "systemd[1]:",
            "systemd:",
            "systemd[908]:",
            "systemd[908]:",
            "systemd[908]:",
            "systemd[908]:",
            "systemd[908]:",
            "systemd[908]:",
            "systemd:",
            "sudo:",
            "sudo:",
            "sshd[1070]:",
            "sshd[1073]:",
            "sshd[1073]:",
            "sshd[1073]:",
            "sshd[1082]:",
            "sshd[1082]:",
            "sshd[1088]:",
            "sshd[1088]:",
            "sshd[1093]:",
            "sshd[1093]:",
            "sshd[1099]:",
            "sshd[1099]:",
            "rsyslogd:",
            "sshd[1104]:",
            "sshd[1104]:",
            "sshd[1104]:",
            "su:",
            "su:",
            "sudo:",
            "su:",
            "su:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "mysql-server_auditing:",
            "CRON[1411]:",
            "rsyslogd:",
            "rsyslogd:",
            "sshd[1467]:",
            "sshd[1467]:",
            "sshd[1473]:",
            "sshd[1473]:",
            "sshd[1478]:",
            "sshd[1479]:",
            "sshd[1482]:",
            "sshd[1114]:",
            "su:",
            "systemd-logind[437]:",
            "sudo:",
            "systemd-logind[437]:",
            "sshd[1501]:",
            "sshd[1499]:",
            "sshd[1500]:",
            "sshd[1502]:",
            "sshd[1501]:",
            "sshd[1497]:",
            "sshd[1502]:",
            "sshd[1499]:",
            "sshd[1498]:",
            "sshd[1500]:",
            "sshd[1515]:",
            "CRON[1521]:",
            "CRON[1521]:",
            "sshd[1531]:",
            "sshd[1531]:",
            "sshd[1558]:",
            "sshd[1575]:",
            "sshd[1575]:",
            "sshd[1581]:",
            "sshd[1583]:",
            "sshd[1586]:",
            "sshd[1586]:",
            "sshd[1588]:",
            "sshd[1592]:",
            "sshd[1595]:",
            "sshd[1599]:",
            "sshd[1603]:",
            "sshd[1669]:",
            "sshd[1673]:",
            "sshd[1676]:",
            "sshd[1676]:",
            "sshd[1678]:",
            "sshd[1681]:",
            "sshd[1684]:",
            "sshd[1687]:",
            "sshd[1691]:",
            "sshd[1693]:",
            "sshd[1693]:",
            "CRON[1696]:",
            "CRON[1696]:",
            "sshd[1699]:",
            "sshd[1702]:",
            "sshd[1705]:",
            "sshd[1708]:",
            "sshd[1713]:",
            "sshd[1716]:",
            "sshd[1718]:",
            "sshd[1718]:",
            "sshd[1724]:",
            "sshd[1727]:",
            "sshd[1730]:",
            "sshd[1734]:",
            "sshd[1737]:"
        ];

        PublicSector::all()->each(function ($institute) use ($messages, $tags) {
            $faker = \Faker\Factory::create();

            SystemEvent::create([
                'public_sector_id' => $institute->id,
                'host_ip' => $faker->ipv4,
                'message' => Arr::random($messages),
                'device_time' => now()->subMinutes(Arr::random([1, 2, 3])),
                'user' => $faker->userAgent,
                'sys_log_tag' => Arr::random($tags)
            ]);
        });
    }
}
